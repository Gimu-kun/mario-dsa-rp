@page "/ranking"
@model mario_dsa_rp.Pages.Ranking.RankingModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Bảng xếp hạng";
}

<div class="min-h-screen flex flex-col items-center py-8 bg-gray-50 p-5">
    <div class="flex items-center gap-4 mb-6">
        <img src="~/assets/ranking-cup.png" alt="Cúp" class="w-16 h-16"> 
        <h1 class="text-3xl font-bold text-gray-800 m-0">Bảng xếp hạng</h1>
    </div>

    <ul class="nav nav-tabs overflow-auto flex-nowrap w-full max-w-4xl" id="myTab" role="tablist" style="white-space: nowrap;">
        <!-- Các tab -->
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Mode == "level" ? "active" : "")" href="/ranking?Mode=level">Xếp hạng cá nhân (Exp)</a>
        </li> 
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Mode == "score" ? "active" : "")" href="/ranking?Mode=score">Xếp hạng cá nhân (Score)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "single" && Model.Diff == "easy" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=easy&Playmode=single">Knap-sack 0/1 (Dễ)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "single" && Model.Diff == "medium" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=medium&Playmode=single">Knap-sack 0/1 (Thường)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "single" && Model.Diff == "hard" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=hard&Playmode=single">Knap-sack 0/1 (Khó)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "multiplay" && Model.Diff == "easy" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=easy&Playmode=multiplay">Knap-sack 0/1 (Đôi - Dễ)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "multiplay" && Model.Diff == "medium" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=medium&Playmode=multiplay">Knap-sack 0/1 (Đôi - Thường)</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(Model.Playmode == "multiplay" && Model.Diff == "hard" ? "active" : "")" href="/ranking?Mode=knapsack&Diff=hard&Playmode=multiplay">Knap-sack 0/1 (Đôi - Khó)</a>
        </li>
    </ul>

    <div class="w-full min-vw-50 rounded-lg relative flex justify-content-center mt-4">
        <div id="ranking-container" class="overflow-y-auto max-h-[500px] relative w-full">
            <table class="table table-striped table-bordered table-hover w-full text-md-center m-0">
                <colgroup>
                    @if (Model.Mode == "level" || Model.Mode == "score")
                    {
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                    }
                    else
                    {
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                        <col style="width: auto;" />
                    }
                </colgroup>
                <thead class="table-primary text-uppercase text-lg sticky-top">
                    <tr>
                        <th>#</th>
                        @if (Model.Mode == "knapsack")
                        {
                            <th>Match ID</th>
                            <th>Take At</th>
                            <th>Spend Time</th>
                        }
                        <th>ID</th>
                        <th>Badge</th>
                        <th>Name</th>
                        <th>@(Model.Mode == "level" ? "Exp" : "Score")</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.RankingList.Length; i++)
                    {
                        var row = Model.RankingList[i];
                        bool isCurrentUser = row.UserId == Model.currentUserRank?.UserId;
                        <tr class="@(isCurrentUser ? "table-warning" : "")" data-rank="@(i+1)">
                            <th>@(i+1)</th>
                            @if (Model.Mode == "knapsack")
                            {
                                <td>@row.ChallengeId</td>
                                <td>@row.TakenAt</td>
                                <td>@FormatSpendTime(row.SpendTime)</td>
                            }
                            <td>@row.UserId</td>
                            <td class="flex justify-content-center">
                                @if (i == 0)
                                {
                                    <img src="assets/gold-badge.png" alt="Badge" class="w-10 h-full object-fit-cover">
                                }
                                else if (i == 1)
                                {
                                    <img src="assets/silver-badge.png" alt="Badge" class="w-10 h-full object-fit-cover">
                                }
                                else if (i == 2)
                                {
                                    <img src="assets/brown-badge.png" alt="Badge" class="w-10 h-full object-fit-cover">
                                }
                                else
                                {
                                    <img src="assets/badge-@(row.BadgeId).png" alt="Badge" class="w-10 h-full object-fit-cover">
                                }
                            </td>
                            <td>@row.Username</td>
                            <td>@(Model.Mode == "level" ? row.Exp : row.Score)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('ranking-container');
            const currentUserRow = container.querySelector('tr.table-warning');
            if (currentUserRow) {
                container.scrollTop = currentUserRow.offsetTop - container.clientHeight / 2 + currentUserRow.clientHeight / 2;
            }
        });

        @functions {
            public string FormatSpendTime(int time)
            {
                int h = time / 3600;
                int m = (time % 3600) / 60;
                int s = time % 60;

                string result = "";
                if (h > 0) result += $"{h}giờ ";
                if (m > 0) result += $"{m}phút ";
                result += $"{s}giây";
                return result.Trim();
            }
        }
    </script>
}
